<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      background-color: var(--bg-color, #f4f4f4);
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: var(--main-color, #0072ff);
      text-align: center;
    }
    .search-box input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .player-strip {
      background-color: #e6f0ff;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    .player-strip:hover {
      background-color: #cce0ff;
    }
    .player-details {
      display: none;
      margin: 10px 0;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    .player-details p {
      margin: 6px 0;
    }
    .player-details input, .player-details select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #aaa;
    }
    .btn {
      padding: 10px;
      margin: 5px 0;
      background-color: var(--main-color, #0072ff);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .day-btn {
      margin: 4px;
      padding: 8px 12px;
      border: 1px solid #0072ff;
      background-color: white;
      color: #0072ff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .day-btn.active {
      background-color: #0072ff;
      color: white;
    }
    .summary {
      margin-top: 10px;
      font-weight: bold;
    }
    .expiring-btn {
      background: orange;
    }
    .ended-btn {
      background: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨...">
    </div>
    <button class="btn expiring-btn" onclick="showExpiring()">â³ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
    <button class="btn ended-btn" onclick="showEnded()">ğŸ“• Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</button>
    <div id="playersList"></div>
  </div>
  <script>
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (user && user.plan === "vip") {
      const vipColor = localStorage.getItem("vipColor");
      if (vipColor) document.documentElement.style.setProperty('--main-color', vipColor);
    }
    const players = JSON.parse(localStorage.getItem("players")) || [];
    const coaches = JSON.parse(localStorage.getItem("coaches")) || [];
    const listContainer = document.getElementById("playersList");
    const searchInput = document.getElementById("searchInput");

    function renderPlayers(filter = "", onlyExpiring = false, onlyEnded = false) {
      listContainer.innerHTML = "";
      const now = new Date();
      players.filter(p => p.name.includes(filter)).forEach((player, index) => {
        const endDate = player.endDate ? new Date(player.endDate) : null;
        const daysLeft = endDate ? Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)) : null;
        if (onlyExpiring && (daysLeft === null || daysLeft > 5)) return;
        if (onlyEnded && (daysLeft === null || daysLeft > 0)) return;
        const strip = document.createElement("div");
        strip.className = "player-strip";
        strip.textContent = `ğŸ‘¤ ${player.name}`;
        const details = document.createElement("div");
        details.className = "player-details";
        details.innerHTML = `
          <p><strong>ğŸ“› Ø§Ù„Ø§Ø³Ù…:</strong> ${player.name}</p>
          <p><strong>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${player.address}</p>
          <p><strong>ğŸ‚ Ø§Ù„Ø³Ù†:</strong> ${player.age}</p>
          <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${player.phone}</p>
          <p><strong>ğŸ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> ${player.level || '-'}</p>
          <p><strong>ğŸ” Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯:</strong> ${player.renewCount || 0}</p>
          <form onsubmit="return saveData(event, ${index})">
            <input type="number" name="price" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" value="${player.price || ''}" required>
            <input type="number" name="paid" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹" value="${player.paid || ''}" required>
            <input type="number" name="sessions" placeholder="ğŸ“† Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±" value="${player.sessions || ''}" required>
            <label>ğŸ“… Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±:</label>
            <div id="days-buttons" class="day-selector">
              ${["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"].map(day => `
                <button type="button" class="day-btn" data-value="${day}">${day}</button>
              `).join('')}
            </div>
            <input type="hidden" name="days" value="${player.days || ''}">
            <label>ğŸ‘¨â€ğŸ« Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø¨:</label>
            <select name="coach" required>
              ${coaches.map(c => `<option value="${c.name}" ${player.coach === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
            </select>
            <div class="summary" id="summary-${index}"></div>
            <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn" type="button" onclick="printInvoice(${index})">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø©</button>
            <button class="btn" type="button" onclick="renew(${index})">â™»ï¸ ØªØ¬Ø¯ÙŠØ¯</button>
            <button class="btn" type="button" onclick="deletePlayer(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button class="btn" type="button" onclick="migrateToAttendance(${index})">ğŸ“‹ ØªØ±Ø­ÙŠÙ„ Ù„Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</button>
          </form>
        `;
        strip.onclick = () => {
          details.style.display = details.style.display === "block" ? "none" : "block";
        };
        listContainer.appendChild(strip);
        listContainer.appendChild(details);
        setupDayButtons(details.querySelector('form'));
      });
    }

    function setupDayButtons(form) {
      const buttons = form.querySelectorAll('.day-btn');
      const hiddenInput = form.querySelector('input[name="days"]');
      const existingDays = hiddenInput.value.split(' - ');
      buttons.forEach(btn => {
        if (existingDays.includes(btn.dataset.value)) {
          btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
          const selected = Array.from(buttons)
            .filter(b => b.classList.contains('active'))
            .map(b => b.dataset.value);
          hiddenInput.value = selected.join(" - ");
        });
      });
    }

    function saveData(e, index) {
      e.preventDefault();
      const form = e.target;
      const price = parseFloat(form.price.value);
      const paid = parseFloat(form.paid.value);
      const sessions = parseInt(form.sessions.value);
      const days = form.days.value;
      const coach = form.coach.value;
      const daysCount = days.split("-").length;
      const today = new Date();
      const weeks = Math.ceil(sessions / daysCount);
      const endDate = new Date();
      endDate.setDate(today.getDate() + weeks * 7);
      players[index].price = price;
      players[index].paid = paid;
      players[index].sessions = sessions;
      players[index].days = days;
      players[index].coach = coach;
      players[index].startDate = today.toLocaleDateString();
      players[index].endDate = endDate.toLocaleDateString();
      localStorage.setItem("players", JSON.stringify(players));
      const perSession = (price / sessions).toFixed(2);
      const summary = document.getElementById(`summary-${index}`);
      summary.innerHTML = `
        âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸<br>
        ğŸ’° Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${price - paid} Ø¬Ù†ÙŠÙ‡<br>
        ğŸ’¸ Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ©: ${perSession} Ø¬Ù†ÙŠÙ‡<br>
        ğŸ—“ï¸ Ù…Ù† ${players[index].startDate} Ø¥Ù„Ù‰ ${players[index].endDate}
      `;
    }

    function renew(index) {
      const player = players[index];
      const start = new Date();
      const daysCount = player.days?.split("-").length || 3;
      const weeks = Math.ceil((player.sessions || 12) / daysCount);
      const end = new Date(start);
      end.setDate(start.getDate() + (weeks * 7));
      player.startDate = start.toLocaleDateString();
      player.endDate = end.toLocaleDateString();
      player.renewCount = (player.renewCount || 0) + 1;
      localStorage.setItem("players", JSON.stringify(players));
      alert("âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.");
      renderPlayers(searchInput.value.trim());
    }

    function deletePlayer(index) {
      if (confirm("âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ")) {
        players.splice(index, 1);
        localStorage.setItem("players", JSON.stringify(players));
        renderPlayers(searchInput.value.trim());
      }
    }

    function printInvoice(index) {
      const p = players[index];
      const win = window.open('', '', 'width=600,height=400');
      win.document.write(`<h3>Ø¥ÙŠØµØ§Ù„ Ø§Ø´ØªØ±Ø§Ùƒ</h3>
        <p>Ø§Ù„Ø§Ø³Ù…: ${p.name}</p>
        <p>Ø§Ù„Ù…Ø¯Ø±Ø¨: ${p.coach}</p>
        <p>Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${p.paid} / ${p.price} Ø¬Ù†ÙŠÙ‡</p>
        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${p.startDate}</p>
        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${p.endDate}</p>`);
      win.print();
    }

    function migrateToAttendance(index) {
      const player = players[index];
      const attendance = JSON.parse(localStorage.getItem("attendanceList")) || [];
      attendance.push(player);
      localStorage.setItem("attendanceList", JSON.stringify(attendance));
      alert("ğŸ“‹ ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ±.");
      window.location.href = "sessions-attendance.html";
    }

    function showExpiring() {
      renderPlayers("", true);
    }

    function showEnded() {
      renderPlayers("", false, true);
    }

    searchInput.addEventListener("input", () => {
      renderPlayers(searchInput.value.trim());
    });

    renderPlayers();
  </script>
  
</body>
<body>
  <div class="container">
  

    <button class="summary-btn" onclick="calculateTotals()">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø´Ù‡Ø±ÙŠ -ÙŠÙˆÙ…ÙŠ - Ø£Ø³Ø¨ÙˆØ¹ÙŠ - Ø³Ù†ÙˆÙŠ)</button>
    <div id="summaryResults"></div>


    <script>
function calculateTotals() {
  const players = JSON.parse(localStorage.getItem("players")) || [];
  let daily = 0, weekly = 0, monthly = 0, yearly = 0;

  players.forEach(p => {
    const paid = parseFloat(p.paid || 0);
    const sessions = parseInt(p.sessions || 0);
    const days = p.days ? p.days.split(" - ") : [];
    const daysPerWeek = days.length || 1;

    const weeks = sessions > 0 && daysPerWeek > 0
      ? Math.ceil(sessions / daysPerWeek)
      : 4;

    const perWeek = paid / weeks;
    const perDay = perWeek / daysPerWeek;

    weekly += perWeek;
    daily += perDay;
    monthly += paid;
  });

  yearly = monthly * 12;

        document.getElementById("summaryResults").innerHTML = `
          ğŸ“ <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</strong> ${daily.toFixed(2)} Ø¬Ù†ÙŠÙ‡
          ğŸ’µ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø´Ù‡Ø±ÙŠÙ‹Ø§:</strong> ${monthly.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
          ğŸ“… <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</strong> ${weekly.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
          ğŸ“† <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø³Ù†ÙˆÙŠ:</strong> ${yearly.toFixed(2)} Ø¬Ù†ÙŠÙ‡
        `;
      }
    </script>
    <script>
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");

  if (currentUser.status === "banned" || currentUser.status === "suspended") {
    const msg = currentUser.status === "banned"
      ? `<div class="message banned"><h2>ğŸš« Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</h2><p>Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p></div>`
      : `<div class="message suspended"><h2>â¸ï¸ Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§</h2><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p></div>`;
    document.write(`<html><head><title>Ø§Ù„Ø­Ø§Ù„Ø©</title></head><body>${msg}</body></html>`);
  }
</script>

  </div>
 
    <button class="btn" style="margin-top: 30px; width: 100%;" onclick="location.href='pool-management.html'">â¬…ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
 
</body>
</html>