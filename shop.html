<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù…ØªØ¬Ø± LV12 â€” Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7770714931220768"
     crossorigin="anonymous"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon" />
  <style>
      .card-hover:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); transition: 220ms; }
    .stars { color: #f6b26b; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
<header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='shop.html'">
        <img src="lv12.ico" class="w-10 h-10 rounded" alt="logo" />
        <div>
          <div class="text-lg font-bold text-blue-700">LV12 Ù…ØªØ¬Ø±Ù†Ø§</div>
          <div class="text-xs text-gray-500">ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</div>
        </div>
      </div>

      <div class="flex-1 px-4">
        <div class="flex gap-3">
          <input id="searchInput" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ø§Ø³Ù…ØŒ Ø£Ùˆ ÙˆØµÙ..." class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          <select id="sortSelect" class="border rounded px-3 py-2">
            <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
            <option value="priceLow">Ø§Ù„Ø£Ø±Ø®Øµ</option>
            <option value="priceHigh">Ø§Ù„Ø£ØºÙ„Ù‰</option>
            <option value="rating">Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹</option>
          </select>
          <a href="cart.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ›ï¸ Ø§Ù„Ø³Ù„Ø©</a>
          <a href="my-orders.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
        </div>
      </div>
      <div id="userArea" class="flex items-center gap-3">
        <span id="userName" class="text-sm text-gray-700 hidden sm:inline"></span>
        <a id="loginBtn" href="shop-login.html" class="text-blue-600 underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>
  </header>
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-2 items-center">
      <div id="categoriesNav" class="flex flex-wrap gap-2"></div>
    </div>
  </nav>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <div id="topInfo" class="mb-6 text-sm text-gray-600">Ø§ÙƒØªØ´Ù Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ±</div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
       <aside class="lg:col-span-1 bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Ø§Ù„ÙÙ„Ø§ØªØ±</h3>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Ø§Ù„ÙØ¦Ø©</label>
          <select id="categoryFilter" class="w-full border p-2 rounded">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
          <select id="stockFilter" class="w-full border p-2 rounded">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="in">Ù…ØªÙˆÙØ±</option>
            <option value="out">Ù…Ù†ÙØ°</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±</label>
          <div class="flex gap-2">
            <input id="priceMin" type="number" placeholder="Ù…Ù†" class="border p-2 rounded w-1/2" />
            <input id="priceMax" type="number" placeholder="Ø¥Ù„Ù‰" class="border p-2 rounded w-1/2" />
          </div>
        </div>

        <div class="mt-4">
          <button id="applyFilters" class="bg-blue-600 text-white px-3 py-2 rounded w-full">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="resetFilters" class="mt-2 bg-gray-200 px-3 py-2 rounded w-full">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </aside>

      <!-- Products grid -->
      <section class="lg:col-span-3">
        <div id="loading" class="text-center text-gray-500 py-16">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
        <div id="productsGrid" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

        <!-- Empty -->
        <div id="noResults" class="hidden text-center text-gray-500 py-10">Ù„Ù… ØªØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
      </section>
    </div>
  </main>

  <!-- Quick View Modal (product preview with similar) -->
  <div id="quickView" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-4xl w-full p-5 relative">
      <button onclick="closeQuickView()" class="absolute left-3 top-3 text-gray-500">âœ–ï¸</button>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div id="qImages" class="md:col-span-1"></div>
        <div class="md:col-span-2">
          <h3 id="qName" class="text-xl font-bold mb-2"></h3>
          <div id="qRating" class="text-sm text-yellow-600 mb-2"></div>
          <p id="qDesc" class="text-gray-700 mb-3"></p>
          <div class="flex items-center gap-4 mb-3">
            <div class="text-2xl font-bold text-blue-700" id="qPrice"></div>
            <div class="text-sm text-gray-600" id="qStock"></div>
          </div>

          <div class="flex gap-2 items-center mb-4">
            <input id="qQty" type="number" value="1" min="1" class="w-20 border p-2 rounded" />
            <button id="qAdd" class="bg-blue-600 text-white px-3 py-2 rounded">â• Ø³Ù„Ø©</button>
            <button id="qBuy" class="bg-green-600 text-white px-3 py-2 rounded">ğŸ’³ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
            <a id="qFull" class="ml-auto text-sm text-blue-600 underline cursor-pointer">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</a>
          </div>

          <div>
            <h4 class="font-semibold mb-2">Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©</h4>
            <div id="qSimilar" class="flex gap-3 overflow-x-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-5 hidden z-50 max-w-xs"></div>

  <footer class="bg-gray-900 text-white text-center py-4 text-sm mt-8">Â© 2025 LV12</footer>

<script>
const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzcWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const productsGrid = document.getElementById("productsGrid");
const loadingEl = document.getElementById("loading");
const noResultsEl = document.getElementById("noResults");
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const categoriesNav = document.getElementById("categoriesNav");
const categoryFilter = document.getElementById("categoryFilter");
const stockFilter = document.getElementById("stockFilter");
const priceMin = document.getElementById("priceMin");
const priceMax = document.getElementById("priceMax");
const applyFiltersBtn = document.getElementById("applyFilters");
const resetFiltersBtn = document.getElementById("resetFilters");
const toastEl = document.getElementById("toast");

const quickView = document.getElementById("quickView");
const qImages = document.getElementById("qImages");
const qName = document.getElementById("qName");
const qDesc = document.getElementById("qDesc");
const qPrice = document.getElementById("qPrice");
const qStock = document.getElementById("qStock");
const qRating = document.getElementById("qRating");
const qQty = document.getElementById("qQty");
const qAdd = document.getElementById("qAdd");
const qBuy = document.getElementById("qBuy");
const qSimilar = document.getElementById("qSimilar");
const qFull = document.getElementById("qFull");

let allProducts = []; // cached loaded products
let displayedProducts = [];
let categories = [];

function showToast(msg, success = true, timeout = 3000) {
  toastEl.innerHTML = `<div class="p-3 rounded-lg ${success ? 'bg-green-600 text-white' : 'bg-red-600 text-white'} shadow">${msg}</div>`;
  toastEl.classList.remove("hidden");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(() => toastEl.classList.add("hidden"), timeout);
}

function escapeHtml(s='') { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

async function fetchProducts({ search = "", category = "", sort = "newest", minPrice = null, maxPrice = null, stock = "" } = {}) {
  loadingEl.classList.remove("hidden");
  productsGrid.classList.add("hidden");
  noResultsEl.classList.add("hidden");

  let query = supabase
    .from("products")
    .select(`
      id, name, description, price, stock, sold, created_at, metadata,
      product_images(image_url, is_primary, ordering),
      product_reviews(rating)
    `);

  if (search) query = query.ilike("name", `%${search}%`);
  // ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø± (metadata->>category case handled later)
  // ÙÙ„ØªØ± Ø§Ù„ÙØ¦Ø©: check metadata->>category or category column
  if (category) {
    // try metadata->>category first (works if metadata JSON used)
    query = query.eq("metadata->>category", category).or(`category.eq.${category}`);
  }

  const { data, error } = await query;
  if (error) {
    console.error("fetchProducts error:", error);
    loadingEl.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª";
    return;
  }

  allProducts = (data || []).map(p => {
    const imgs = (p.product_images || []).slice().sort((a,b) => (a.ordering||0) - (b.ordering||0));
    const primary = imgs.find(x => x.is_primary) || imgs[0] || { image_url: null };
    const ratings = (p.product_reviews || []).map(r => Number(r.rating)).filter(Boolean);
    const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length) : null;
    // category fallback (metadata JSON or column)
    const cat = (p.metadata && p.metadata.category) ? p.metadata.category : (p.category || "");
    return {
      ...p,
      primaryImage: primary.image_url,
      avgRating: avg ? (Math.round(avg*10)/10) : null,
      reviewCount: ratings.length,
      category: cat
    };
  });

  displayedProducts = allProducts.filter(prod => {
    if (minPrice != null && prod.price < minPrice) return false;
    if (maxPrice != null && prod.price > maxPrice) return false;
    if (stock === "in" && (!prod.stock || prod.stock <= 0)) return false;
    if (stock === "out" && prod.stock > 0) return false;
    return true;
  });

  categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();

  renderCategories();
  applySortAndRender(sort);

  loadingEl.classList.add("hidden");
  productsGrid.classList.remove("hidden");
}

/* ---------- Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---------- */
function renderCategories() {
  categoriesNav.innerHTML = `<button class="px-3 py-1 rounded bg-blue-100" onclick="onCategoryClick('')">Ø§Ù„ÙƒÙ„</button>`;
  categoryFilter.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>`;
  categories.forEach(cat => {
    categoriesNav.innerHTML += `<button class="px-3 py-1 rounded bg-gray-100" onclick="onCategoryClick('${escapeHtml(cat)}')">${escapeHtml(cat)}</button>`;
    categoryFilter.innerHTML += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
  });
}

function applySortAndRender(sort = sortSelect.value) {
  let products = [...displayedProducts];
  switch (sort) {
    case "priceLow": products.sort((a,b)=>a.price - b.price); break;
    case "priceHigh": products.sort((a,b)=>b.price - a.price); break;
    case "rating": products.sort((a,b)=> (b.avgRating||0)-(a.avgRating||0)); break;
    default: products.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  }
  renderProducts(products);
}

/* ---------- Ø±ÙŠÙ†Ø¯Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---------- */
function renderProducts(products) {
  productsGrid.innerHTML = "";
  if (!products || products.length === 0) {
    noResultsEl.classList.remove("hidden");
    productsGrid.innerHTML = "";
    return;
  }
  noResultsEl.classList.add("hidden");

  products.forEach(prod => {
    const card = document.createElement("div");
    card.className = "bg-white rounded-lg shadow p-0 overflow-hidden flex flex-col card-hover";

    const img = prod.primaryImage || "https://via.placeholder.com/400x300?text=No+Image";
    card.innerHTML = `
      <a href="#" class="block" onclick="openProduct(${prod.id});return false;">
        <img src="${img}" class="w-full h-44 object-cover" alt="${escapeHtml(prod.name)}" />
      </a>
      <div class="p-3 flex-1 flex flex-col">
        <a href="#" onclick="openProduct(${prod.id});return false;" class="font-semibold text-gray-800">${escapeHtml(prod.name)}</a>
        <div class="text-xs text-gray-500 mt-1 flex-1">${escapeHtml((prod.description||'').slice(0,90))}</div>
        <div class="mt-3 flex items-center justify-between gap-2">
          <div>
            <div class="text-lg font-bold text-blue-700">${prod.price} Ø¬.Ù…</div>
            <div class="text-xs text-gray-500">Ø§Ù„Ù…ØªÙˆÙØ±: ${prod.stock ?? 0}</div>
          </div>
          <div class="text-right">
            <div class="stars text-sm mb-1">${prod.avgRating ? `â­ ${prod.avgRating}` : 'Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ…'}</div>
            <div class="flex gap-2">
              <button onclick="quickViewOpen(${prod.id});event.stopPropagation();" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm">ğŸ” Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹</button>
              <button onclick="addToCartFromCard(${prod.id});event.stopPropagation();" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">â• Ø³Ù„Ø©</button>
            </div>
          </div>
        </div>
      </div>
    `;
    productsGrid.appendChild(card);
  });
}

function addToCartFromCard(productId) {
  const p = allProducts.find(x => x.id === productId);
  if (!p) return showToast("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", false);
  const qty = 1;
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const existing = cart.find(i=>i.id===productId);
  if (existing) existing.quantity = Math.min((existing.quantity||0)+qty, p.stock||9999);
  else cart.push({ id: p.id, name: p.name, price: p.price, quantity: qty });
  localStorage.setItem("cart", JSON.stringify(cart));
  showToast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©");
}

function openProduct(productId) {
  // Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ product.html Ù„Ø§Ø­Ù‚Ø§Ù‹)
  window.location.href = `product.html?id=${productId}`;
}

async function quickViewOpen(productId) {
  const { data, error } = await supabase
    .from("products")
    .select(`
      id, name, description, price, stock, sold, created_at, metadata,
      product_images(image_url, is_primary, ordering),
      product_reviews(rating, comment)
    `)
    .eq("id", productId)
    .single();

  if (error || !data) {
    console.error("quickView error:", error);
    return showToast("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬", false);
  }

  const prod = data;
  const imgs = (prod.product_images || []).slice().sort((a,b)=> (a.ordering||0)-(b.ordering||0));
  const primary = imgs.find(x=>x.is_primary) || imgs[0] || { image_url: null };
  const ratings = (prod.product_reviews||[]).map(r=>Number(r.rating)).filter(Boolean);
  const avg = ratings.length ? (Math.round(ratings.reduce((a,b)=>a+b,0)/ratings.length*10)/10) : null;

  qImages.innerHTML = imgs.length ? imgs.map(i=>`<img src="${i.image_url}" class="w-full rounded mb-2">`).join('') : `<img src="https://via.placeholder.com/400x300" class="w-full rounded">`;
  qName.textContent = prod.name;
  qDesc.textContent = prod.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
  qPrice.textContent = prod.price + " Ø¬.Ù…";
  qStock.textContent = (prod.stock && prod.stock>0) ? `Ù…ØªÙˆÙØ±: ${prod.stock}` : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
  qRating.innerHTML = avg ? `â­ ${avg} (${ratings.length})` : "Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ…";
  qQty.value = 1;
  qAdd.onclick = () => {
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const existing = cart.find(i=>i.id===prod.id);
    if (existing) existing.quantity = Math.min((existing.quantity||0)+Number(qQty.value), prod.stock||9999);
    else cart.push({ id: prod.id, name: prod.name, price: prod.price, quantity: Number(qQty.value) });
    localStorage.setItem("cart", JSON.stringify(cart));
    showToast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©");
  };
  qBuy.onclick = () => {
    // Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù†Ø³ØªØ®Ø¯Ù… buy modal ÙÙŠ cart.html Ø¹Ø§Ø¯Ø©) - Ù‡Ù†Ø§ Ø³Ù†Ø­ÙØ¸ Ù„Ù„Ø³Ù„Ø© ÙˆÙ†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ù„Ø©
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const existing = cart.find(i=>i.id===prod.id);
    if (existing) existing.quantity = Math.min((existing.quantity||0)+Number(qQty.value), prod.stock||9999);
    else cart.push({ id: prod.id, name: prod.name, price: prod.price, quantity: Number(qQty.value) });
    localStorage.setItem("cart", JSON.stringify(cart));
    showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© â€” Ø§Ù†ØªÙ‚Ù„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡");
    closeQuickView();
    setTimeout(()=> window.location.href = "cart.html", 700);
  };

  qSimilar.innerHTML = "";
  const cat = (prod.metadata && prod.metadata.category) ? prod.metadata.category : (prod.category||"");
  if (cat) {
    const similar = allProducts.filter(x => x.category === cat && x.id !== prod.id).slice(0,6);
    if (similar.length) {
      similar.forEach(s => {
        const el = document.createElement("div");
        el.className = "w-36 p-2 bg-gray-50 rounded";
        el.innerHTML = `<img src="${s.primaryImage||'https://via.placeholder.com/200'}" class="w-full h-20 object-cover rounded mb-1"><div class="text-xs font-medium">${escapeHtml(s.name)}</div><div class="text-sm text-blue-700 font-semibold">${s.price} Ø¬.Ù…</div>`;
        el.onclick = ()=> { closeQuickView(); openProduct(s.id); };
        qSimilar.appendChild(el);
      });
    } else {
      qSimilar.innerHTML = `<div class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø¨Ù‡Ø§Øª</div>`;
    }
  } else {
    qSimilar.innerHTML = `<div class="text-sm text-gray-500">ØºÙŠØ± Ù…ØªÙˆÙØ± ØªØµÙ†ÙŠÙ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø´Ø§Ø¨Ù‡</div>`;
  }

  quickView.classList.remove("hidden");
  quickView.classList.add("flex");
  qFull.onclick = () => { closeQuickView(); openProduct(prod.id); };
}

function closeQuickView() {
  quickView.classList.add("hidden");
  quickView.classList.remove("flex");
}

searchInput.addEventListener("input", debounce(()=> {
  fetchWithUi();
}, 300));

sortSelect.addEventListener("change", ()=> applySortAndRender());

applyFiltersBtn.addEventListener("click", () => fetchWithUi());
resetFiltersBtn.addEventListener("click", () => {
  categoryFilter.value = "";
  stockFilter.value = "";
  priceMin.value = "";
  priceMax.value = "";
  fetchWithUi();
});

function fetchWithUi() {
  const search = searchInput.value.trim();
  const category = categoryFilter.value;
  const sort = sortSelect.value;
  const min = priceMin.value ? Number(priceMin.value) : null;
  const max = priceMax.value ? Number(priceMax.value) : null;
  const stock = stockFilter.value;
  fetchProducts({ search, category, sort, minPrice: min, maxPrice: max, stock });
}

function debounce(fn, wait=250) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
}

async function checkLogin() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  const userName = document.getElementById("userName");
  const loginBtn = document.getElementById("loginBtn");
  if (session?.user) {
    userName.textContent = session.user.email;
    userName.classList.remove("hidden");
    loginBtn.classList.add("hidden");
  } else {
    userName.classList.add("hidden");
    loginBtn.classList.remove("hidden");
  }
}

(async function init(){
  await checkLogin();
  await fetchProducts();
})();

function addToCart(productId) { addToCartFromCard(productId); }
function onCategoryClick(cat) { categoryFilter.value = cat; fetchWithUi(); }
function openProductPage(id) { openProduct(id); }

</script>
</body>
</html>
